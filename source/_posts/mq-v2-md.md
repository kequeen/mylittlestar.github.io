---
title: 小雨伞消息队列演化.md
date: 2019-01-23 19:42:32
tags:
---
## 前言
消息队列（Message queue，下面简称MQ）是一种进程间通信或同一进程的不同线程间的通信方式，常用于消息分发、系统解耦，流量削峰填谷等方面，是大型分布式系统不可或缺的中间件。
消息队列有两种模型，点对点和发布/订阅模型。小雨伞发展初期，只使用了点对点模型就满足了我们的需求，而随着业务的发展，原有的点对点模型越来越难以支撑业务的发展，增加发布订阅模型的事情也提上了日程。


### 消息队列1.0
我们初期只采用了消息队列的点对点模型。原因如下：
- 业务模型相对比较简单，点对点已经满足需求
- redis 实现的发布/订阅模型，其可靠性无法满足我们的需求

业务发展初期，小雨伞的消息队列的使用场景主要于以下方面：
- 支付完成异步通知出单
- 出单系统將消息分发下去，分发给每个保险公司的独立的出单进程进行处理
- 邮件的异步发送
- 订单系统通知触达系统给用户发送触达
上面的业务需求都是单系统-单系统之间的交互，或者是系统内部进行消息分发，只是用点对点模型已经可以满足其要求

redis的发布与订阅功能，其无法对消息进行持久化，意味着一旦消费者异常断开，此时若有消息发送，那么消费者会直接丢失此消息。
![](mq_redis.png)
而在我们的业务环境中，我们发现 phpredis 维持的连接中，如果长时间没有消息传输，其容易进入一个假死的状态，就是常驻进程还在运行，但是其与 redis 服务器的连接却已经断开了。在我们的业务场景下，这也是比较常见的，毕竟有的保险公司出单量少。并且系统高负载的情况下，redis 连接断开也会更加频繁，我们也要考虑到这些异常情况。所以，我们需要更可靠的消息队列模型。

小雨伞消息队列1.0底层是使用redis的list数据结构来实现的，通过rpush与lpop操作实现消息的入栈与出栈。其虽然没有实现发布/订阅模型，但是其点对点模型是相对可靠的。因为就算是消息消费者因为异常原因断开连接，消息也会保存在 redis 服务器的 list 中，只要消费者重新恢复连接，就能够取到之前的消息进行消费。


####消息队列1.0优点：
1. 模型简单
2. 调用方便

但是随着业务的增长，消息队列1.0在功能和管理上越来越难以满足我们的业务需求。

### 消息队列2.0


