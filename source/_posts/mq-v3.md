---
title: 小雨伞消息队列演化.md
date: 2019-02-24 22:40:42
tags:
---
### 前言
消息队列（Message queue，下面简称MQ）是一种进程间通信或同一进程的不同线程间的通信方式，常用于消息分发、系统解耦，流量削峰填谷等方面，是大型分布式系统不可或缺的中间件。
消息队列有两种模式，点对点和发布/订阅模式，点对点模式可以理解为发布/订阅模式的特例，其代表发布者与订阅者之间的关系为1:1,发布/订阅模型的话，发布者与订阅者的关系为1:N。小雨伞发展初期，只使用了点对点模式就满足了业务的需求，而随着业务的发展，原有的点对点模式越来越难以满足业务的需求，同时业务方也要求更高的可靠性，更及时的消息消费告警系统。

### 消息队列1.0
业务初期只采用了消息队列的点对点模式。原因如下：
- 公司发展初期，业务模型相对比较简单，点对点模式已经能够满足需求
- 系统本身使用redis作为缓存，基于redis进行消息队列的二次开发能够降低开发成本
- redis 实现的发布/订阅模型，其可靠性无法得到保证。具体原因如下：
redis的发布与订阅功能，其无法对消息进行持久化，意味着一旦订阅者发生异常，此时若有消息发送，那么系统会直接丢失此消息。作为金融公司，可靠性一定是要得到保证的。

因此，我们使用了redis的list实现了消息队列1.0系统。

消息队列1.0支撑了公司初期的业务发展，但随着业务规模的扩张，一些不足也逐渐暴露。
- 没有发布/订阅模式，当多个业务都要用到同一个消息的时候，无法方便地进行解耦
- 常驻消费进程没有实现柔性重启，导致进程重启的时候会造成消息的异常丢失
- 常驻消费进程需要手动配置，需要手动去指定启动的机器与启动的进程数，增加了开发的不必要工作量
- redis的长连接长时间无消费动作的无感知超时问题（详情可见）

为了解决上述的这些问题，公共平台组决定进行消息队列2.0的开发。

### 消息队列2.0
设计的最主要方向是从架构上去优化原有的消息队列1.0。
消息队列2.0的特点：
- 底层消息系统的改变对业务方应当是无感知的
意思就是不论我们选择 redis、kafka、rabbitmq 或者其它 mq 组件，业务方的调用方式应当是统一的。
- 支持发布/订阅模型，并在管理后台支持配置
管理后台统一配置发布/订阅关系，能够一目了然地看到当前业务间的监听关系。
- 在管理后台可以手动配置常驻消费进程
管理后台同时可以进行消费进程的配置，配置对应群组机器的消费进程个数，并能够同时关闭和启动机器上的消费进程。比如群组有M台机器，配置的进程数为N，那么将同时有M x N个进程来消费队列中的消息，能够很方便地进行消息消费的横向扩容。
- 支持柔性重启
通过捕捉信号量的方式，我们实现了消费进程的柔性重启，增加了消息消费的稳定性。
- 增加对消息消费情况的告警
业务方可以在管理后台配置消息的告警阈值，当业务待消费的消息达到阈值时，我们将对其进行告警。在消息队列1.0阶段，我们的监控需要业务方自行监控，而这监控大多数时候都是类似的。我们这次加了统一的监控，也是为了能够让业务方更专注于其业务上，公共的这些告警逻辑本就应该抽象出来。
- 增加消息消费的确认模式
消息队列1.0时代，消息消费异常的话，只能通过业务方来保证最终一致性，现在我们可以由 MQ 系统来主动进行重试，提高业务的效率。


### 总结
消息队列是实现服务解耦不可或缺的重要组件，我们根据业务的发展与其实际使用场景，适时地设计了满足业务需求的消息队列。从使用效果上来说，设计是符合业务发展需求的。本文只是对系统的宏观设计作了一定的说明，具体的实现细节，如果大家感兴趣，欢迎留言咨询。






