---
title: 小雨伞消息队列进阶之路
date: 2019-01-20 20:17:23
tags:
---
wiki上的定义，消息队列（Message queue，下面简称MQ）是一种进程间通信或同一进程的不同线程间的通信方式。


## 背景介绍
### 消息队列1.0
小雨伞原有消息队列底层是使用redis的list数据结构来实现的，通过rpush与lpop操作实现消息的入栈与出栈。
![](old_mq.png)
消息队列1.0优点：
1. 实现简单
2. 调用方便
但是随着业务的增长，消息队列1.0在功能和管理上越来越难以满足我们的业务需求。

### 业务痛点
原有消息队列1.0有以下业务痛点：
1. 不支持发布订阅，只支持了点对点模型
2. 不支持消费应答，即无法通过消息系统保证消息一定被成功处理，只能通过业务的最终一致性来进行保证
3. 无法直观看到当前消息系统的消费情况，只能通过业务告警来发现消息系统的异常

### 方案选择
我们比对了当前市场上的诸多方案，与我们的业务进行适配，并最终选择了rabbitmq来搭建我们的消息队列2.0
下面说一下我们为什么没有选择其他方案：
redis:
redis高版本推出了发布订阅功能，但是无法解决上面提出的业务痛点2、3
kafka:
官方不支持php
阿里云的MQ:
按照topic与消息流量进行双重收费，而我们的业务类型 topic 会比较多，但是流量初期可能并不多，价格上不划算；不开源，相对于我们是黑盒，很难进行二次开发，满足我们的个性化需求

## 消息系统2.0
底层基于 rabbitmq 实现，完美满足我们的业务痛点，开源，并且官方提供了 http 接口来对消息进行管理，我们可以方便地进行二次开发，满足我们的一些特殊业务需求




